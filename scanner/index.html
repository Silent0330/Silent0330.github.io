<!DOCTYPE html>
<html>

  <head>
    <base target="_top">
    <script type="text/javascript" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <title>報到系統</title>
    <link rel="stylesheet" type="text/css" href="index.css">
  </head>

  <body>
    <div id="div_contents">
      <div id="div_head">
        <div id="div_head_box">
          <h1 id="h_title">報到系統 </h1>
          <h1 id="h_subtitle">自助報到</h1>
        </div>
      </div>
      <div id="div_form">
        <div id="div_page_box">
          <button class="btn_page" onclick="onclick_page_key_scanner();">同工掃描器</button>
        </div>
        <div id="div_form_box">
          <div id="div_controlls">
            <select id="select_onsite">
              <option value="現場">現場</option>
              <option value="線上">線上</option>
            </select>
            <div id="div_cam_switch">
              <label>相機</label>
              <label class="switch">
                <input id="input_cam_switch" type="checkbox" onclick="onclick_btn_cam_switch();">
                <span class="slider round"></span>
              </label>
            </div>
          </div>
          <div id="reader"></div>
        </div>
      </div>
    </div>
    <script>
      
      let initial = false; 
      var line_uid = '';
      
      var cam_off = true;
      const input_cam_switch = document.getElementById("input_cam_switch");
      const select_onsite = document.getElementById("select_onsite");
      const html5QrCode = new Html5Qrcode("reader");
      const config = {
          fps: 25,
          qrbox: {
              width: 350,
              height: 350
          }
      };

      const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        if (initial) {
          stop_scan();
          let hash = CryptoJS.HmacSHA256(line_uid, decodedText);
          hash = hash.toString(CryptoJS.enc.Hex);

          let data = {
              'action': '主日簽到',
              'line_uid': line_uid,
              'type': select_onsite.selectedIndex+1,
              'valid_code': hash,
          };
          let form = document.createElement('form');
          form.method = 'post';
          form.action = '/';
          document.body.appendChild(form);

          for (const key in data) {
              const formField = document.createElement('input');
              formField.type = 'hidden';
              formField.name = key;
              formField.value = data[key];

              form.appendChild(formField);
          }
          form.submit();
        }
        else {
          alert('初始失敗');
        }
      };

      function start_scan() {
          html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
          cam_off = false;
          input_cam_switch.checked = true;
      }
      function stop_scan() {
          html5QrCode.stop().then((ignore) => {
              // QR Code scanning is stopped.
          }).catch((err) => {
              // Stop failed, handle it.
          });
          cam_off = true;
          input_cam_switch.checked = false;
      }

      function onclick_btn_cam_switch() {
          if (cam_off) {
              start_scan();
          }
          else {
              stop_scan();
          }
      }

      function onclick_page_key_scanner() {
        let data = {
            'action': '主動掃描',
            'line_uid': line_uid,
        };
        let form = document.createElement('form');
        form.method = 'post';
        form.action = '/';
        document.body.appendChild(form);

        for (const key in data) {
            const formField = document.createElement('input');
            formField.type = 'hidden';
            formField.name = key;
            formField.value = data[key];

            form.appendChild(formField);
        }
        form.submit();
      }
    </script>
  </body>

</html>